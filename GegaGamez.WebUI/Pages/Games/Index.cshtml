@page "{id:int}"
@model GegaGamez.WebUI.Pages.Games.IndexModel
@{
    AuthDisplayHelper authHelper = new(User);

    bool logedIn = authHelper.IsAuthenticated;

    int? userId = authHelper.UserId;
}

<div class="page-content-header border-primary ">
    <a class="go-back-arrow" href="#"><i class="fa-solid fa-arrow-left font-primary"></i></a>
    <h2 class="font-contrast title">@Model.Game.Title</h2>
</div>
<article id="about-game" class="flex-container">
    <img id="game-img" class="img-standard" src="/img/game.png" alt="Game img" />

    <section id="game-text-info" class="text-info-block">
        <h1>@Model.Game.Title</h1>
        
        <span>
            @if(Model.Game.AvgRatingScore.HasValue)
            {
                <span>@Model.Game.AvgRatingScore</span>
            }
            else
            {
                <span class="font-contrast">No rating yet</span>
            }
            @if (Model.UserRatingForGame.HasValue)
            {
                <span class="font-contrast"> / My rating - @Model.UserRatingForGame.Value</span>
            }
         
        </span>
        <span class="font-secondary">
            <a href="#" class="font-secondary">@Model.Game.Developer.Name</a>, <span>Price</span>
        </span>

        <span class="font-secondary">
            @foreach(var genre in Model.GameGenres)
            {
                <span>@genre.Name</span>
            }
        </span>

        <span>
            @Model.Game.Description
        </span>
    </section>

    <section class="btn-group">
        @if(logedIn == true)
        {
           <button type="button" class="btn-contrast rounded" onclick="showCollectionModal()">Add to</button>
           <button type="button" class="btn-contrast rounded" onclick="showRateGameModal()">Rate</button> 
        }
    </section>
</article>

<section id="comments-section">
    <h3>Comments</h3>

    @if(logedIn == true)
    {
        <button type="button" class="font-primary borderless link-default btn-add-comment">
            Add comment
        </button>
        <form asp-page-handler="Comment" method="post" class="flex-container form-add-comment">
            <img class="img-standard circle user-avatar" src="/img/avatar.png" alt="Alternate Text" />
            <input asp-for="NewComment.UserId" value="@userId" hidden/>
            <input asp-for="NewComment.GameId" value="@Model.Game.Id" hidden />

            <textarea asp-for="NewComment.Text" class="comment-textarea" placeholder="Enter your comment here..."></textarea>

            <div class="btn-group comment-actions">
                <button type="submit" class="btn-add-comment btn-contrast btn-icon"><i class="fa-regular fa-paper-plane"></i></button>
            </div>
        </form>
    }
    @foreach(var comment in Model.Comments)
    {
        // generate comments

        <article class="flex-container game-comment">
			<a asp-page="/Users/Index" asp-route-id="@comment.User.Id">            
                <img class="img-standard circle user-avatar" src="/img/avatar.png" alt="Alternate Text" />
            </a>

        <!--<h3>Username</h3>-->

            <span>
                @comment.Text
                <span class="font-secondary">
                    - Date
                </span>
            </span>

            <div class="btn-group comment-actions">
                
                @if(comment.User.Id == userId){
                    <button type="button" onclick="showDeleteCommentModal(@comment.Id)" class="btn-contrast btn-icon btn-remove-comment"><i class="fa-solid fa-trash"></i></button>
                }
            </div>
        </article>
    }
  
</section>

<form method="post" id="delete-comment-modal" class="popup-interactive bg-secondary border-primary">
    <h3 class="font-contrast">Delete this comment?</h3>
    <input type="number" name="id" value="@Model.Game.Id" readonly />
    <section class="popup-actions">
        <button type="submit" class="borderless">Do something</button>
        <button type="button" onclick="hideDeleteCommentModal()" class="btn-contrast rounded">Cancel</button>
    </section>
</form>

<!-- MOVE GAME TO COLLECTION modal!!! -->
<form asp-page-handler="MoveGameToCollection" method="post" id="move-game-to-collection-modal" class="popup-interactive bg-secondary border-primary">
	@*<input asp-for value=@Model.Game.Id />*@
    <h3 class="font-contrast">
        Select collection:
    </h3>
    <input asp-for=GameToDefaultCollection.GameId value=@Model.Game.Id readonly hidden />
    <input asp-for=GameToUserCollection.GameId value=@Model.Game.Id readonly hidden />
    <div>
        <select size="5" asp-for=GameToDefaultCollection.CollectionId asp-items=@Model.AvailableDefaultCollections></select>
    </div>
	<div>
        <select size="5" asp-for=GameToUserCollection.CollectionId asp-items=@Model.AvailableUserCollections></select>
    </div>

    <section class="popup-actions">
        <button type="submit" class="borderless">Ok</button>
        <button type="button" onclick="hideCollectionModal()" class="btn-contrast rounded">Cancel</button>
    </section>
    @*<select title="Collection">
        @foreach (var defaultCollection in new List<string>())
        {
            <option value="Planned">Planned</option>
        }

        @foreach(var userCollection in new List<string>())
        {
            <option value="Favorites or something">My Absolute favorites</option>
        }

        <!--!!! REMOVE THIS LATER !!!-->
        <option value="Planned">Planned</option>
        <option value="Playing">Playing</option>
        <option value="Completed">Completed</option>
        <option value="Dropped">Dropped</option>

        <option value="Planned">My Favorites</option>
        <option value="Playing">To me whey hey hey YEAH!</option>
        <option value="Completed">Lorem Ipsum</option>
        <option value="Dropped">Dolor sit amet</option>
    </select>*@

</form>

<!-- Rate game modal -->
<form method="post" asp-page-handler="RateGame" id="rate-game-modal" class="popup-interactive bg-secondary border-primary">
    <h3 class="font-contrast">
        How do you rate this game?
    </h3>
    @*<input type="number" name="id" readonly hidden />*@
    <input asp-for="UpdateUserRating.GameId" value="@Model.Game.Id" hidden/>
    <input asp-for="UpdateUserRating.UserId" value=@userId  hidden/>
    <select asp-for="UpdateUserRating.RatingScore" title="Score?" asp-items=@Model.AvailableRatingScores></select>
    <section class="popup-actions">
        <button type="submit" class="borderless">Rate!</button>
        <button type="button" onclick="hideRateGameModal()" class="btn-contrast rounded">Cancel</button>
    </section>
</form>